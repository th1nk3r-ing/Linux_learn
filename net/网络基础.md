# <font color=#0099ff> **网络基础知识 base** </font>

> `@think3r` 2025-02-21 23:34:50
>
> 1. <<图解网络硬件>>
> 2. [如果让你来设计网络](https://mp.weixin.qq.com/s?__biz=MzkxMDc1MDg1Nw==&mid=2247508504&idx=1&sn=b21196cfd1c3cbde80119240c9d2cd81&source=41#wechat_redirect)
>    - [集线器、网桥、交换机、路由器](https://zhuanlan.zhihu.com/p/649762444)
>    - [硬核图解！30张图带你搞懂！路由器，集线器，交换机，网桥，光猫有啥区别？](https://golangguide.top/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9/%E7%A1%AC%E6%A0%B8%E5%9B%BE%E8%A7%A3%EF%BC%8130%E5%BC%A0%E5%9B%BE%E5%B8%A6%E4%BD%A0%E6%90%9E%E6%87%82%EF%BC%81%E8%B7%AF%E7%94%B1%E5%99%A8%EF%BC%8C%E9%9B%86%E7%BA%BF%E5%99%A8%EF%BC%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA%EF%BC%8C%E7%BD%91%E6%A1%A5%EF%BC%8C%E5%85%89%E7%8C%AB%E6%9C%89%E5%95%A5%E5%8C%BA%E5%88%AB%EF%BC%9F.html)
>    - <https://github.com/xiaobaiTech/golangFamily>
> 3. [FPGA是网络交换领域的不二选择](https://zhuanlan.zhihu.com/p/112055720)

## <font color=#009A000> 0x00 网络硬件 </font>

### <font color=#FF4500> ~~0.~~ </font>

1. 中继器 : 放大信号, L1
2. ~~网桥~~

### <font color=#FF4500> 1. 集线器 </font>

- 两台电脑可以通过一根网线直接连接，进行通信。
- 机器一多，可以把网线都接到 ~~**集线器 (HUB)**~~（物理层）上，但是集线器会不管三七二十一进行广播。
  - **一个电脑一般只有一个网口 + 布线的复杂性**
  - 内部电路线缆的直接物理连接
- 数学表示 :
  - 矩阵 𝐻 的每一行代表一个端口的输出情况，值为1表示该端口的数据会被广播到其他端口，值为 0 表示该端口的数据不会传输到自己。
  - 如果我们表示集线器中第 $i$ 个端口接收到的数据为 $x_i$，那么集线器广播后的输出数据 $y_i$ 可以表示为：
    $$
    H =
    \begin{bmatrix}
    0 & 1 & 1 & \dots & 1 \\
    1 & 0 & 1 & \dots & 1 \\
    1 & 1 & 0 & \dots & 1 \\
    \vdots & \vdots & \vdots & \ddots & \vdots \\
    1 & 1 & 1 & \dots & 0
    \end{bmatrix}
    \\[5px]
    y_i = \sum_{j=1, j \neq i}^{n} x_j
    $$
  ![HUB](../image/net_hub.gif)

### <font color=#FF4500> 2. 交换机 </font>

- 不想广播，可以用（**二层**）交换机（SWITCH, 数据链路层），又叫 **交换式集线器**，它比较聪明，会自我学习生产 MAC 地址表，知道消息发到哪，那就不需要广播啦
  - 将连接着两台通信终端的两个端口在装置内部绑定, 使其它端口的信号无法介入, 从而防止发生冲突.
  - 交换机，是不具备 MAC 地址的，而数据包的 MAC 报头是需要填上目的 MAC 地址的。因此交换机从来都不是数据的目的地，它只简单转发数据帧到目的地
  - 交换机的处理能力 :
    - 背板容量(backplane) / 交换机容量 : $端口数量 * 2 * 单口速速$
    - 非阻塞式(non-blocking)
    - 交换结构过载(over-subscription)
  - ~~不具备 mac 地址, 则证明其不属于联网电脑的对等层次.~~

    ![SWITCH](../image/net_switch.gif)

    ![switchs](../image/net_switchs.webp)

### <font color=#FF4500> 3. 路由器 </font>

- 随着网络规模的扩大，交换机开始力不从心了 :
  - 问题的根本在于，上图中连出去的那根红色的网线，后面不知道有多少个设备不断地连接进来，**从而使得 MAC 地址表越来越大**。
  - 那我可不可以让那根红色的网线，接入一个新的设备，这个设备就跟电脑一样有自己独立的 MAC 地址，而且同时还能帮我把数据包做一次转发呢？
  - 改用路由器（网络层），也叫 **三层** 交换机 <br/>
    ![route](../image/net_route1.webp)
- Q&A :
  1. 两个设备之间通信, 怎样知道是否要通过路由器转发呢?
     - 通过引入新的字段 `ip + mask`, 来标明子网
     - 不同子网范围内的设备才需要经过路由器
  2. A 如何知道，哪个设备是路由器？
     - 其实说发给路由器不准确，应该说 A 会把包发给 **默认网关**
     - 对 A 来说，A 只能直接把包发给同处于一个子网下的某个 IP 上，所以发给路由器还是发给某个电脑，对 A 来说也不关心，只要这个设备有个 IP 地址就行。
     - 所以默认网关，就是 A 在自己电脑里配置的一个 IP 地址，以便在发给不同子网的机器时，发给这个 IP 地址。
  3. 路由器如何知道 C 在哪里？
     - 通过路由表, 让自己知道收到的这个数据包，该从自己的哪个端口出去
       - 路由表中记录的是 子网+其对应的端口号
     - 路由表由路由算法得出
  4. 刚才说的都是 IP 层，但发送数据包的数据链路层需要知道 MAC 地址，可是我只知道 IP 地址该怎么办呢？
     - 假如你（A）此时不知道你同伴 B 的 MAC 地址（现实中就是不知道的，刚刚我们只是假设已知），你只知道它的 IP 地址，你该怎么把数据包准确传给 B 呢？
     - 答案很简单，在网络层，我需要把 IP 地址对应的 MAC 地址找到，也就是通过某种方式，找到 `192.168.0.2` 对应的 MAC 地址 BBBB。这种方式就是 `arp` 协议，同时电脑 A 和 B 里面也会有一张 `arp` 缓存表，表中记录着 IP 与 MAC 地址的对应关系。
- 角色视角 :
  1. 电脑视角：
     - 首先我要知道我的 IP 以及对方的 IP (都知道了才能通信)
     - 通过子网掩码判断我们是否在同一个子网
     - 在同一个子网就通过 arp 获取对方 mac 地址直接扔出去
     - 不在同一个子网就通过 arp 获取默认网关的 mac 地址直接扔出去
  2. 交换机视角：
     - 我收到的数据包必须有目标 MAC 地址
     - 通过 MAC 地址表查映射关系
     - 查到了就按照映射关系从我的指定端口发出去
     - 查不到就所有端口都发出去
  3. 路由器视角：
     - 我收到的数据包必须有目标 IP 地址
     - 通过路由表查映射关系
     - 查到了就按照映射关系从我的指定端口发出去（不在任何一个子网范围，走其路由器的默认网关也是查到了）
     - 查不到则返回一个路由不可达的数据包
  4. 三张表 :
     1. 交换机中有 MAC 地址表用于映射 MAC 地址和它的端口(物理端口号, 区别于 `ip:port`)
        - MAC 地址表是通过以太网内各节点之间不断通过交换机通信，不断完善起来的。
        - 当出现一个不知道的 dst mac 地址时, 会将数据包进行广播(flooding).
        - 上述 mac 表的记录会有超时值(mac 地址的老化时间 aging time), 以此来避免设备物理结构的变化和 mac 表对应失败
     2. 路由器中有路由表用于映射 IP 地址(段)和它的端口
        - 路由表是各种路由算法 + 人工配置逐步完善起来的
        - 路由器 1 连接了路由器 2，所以其路由表有了下一条地址(下一跳)这一个概念
     3. 电脑和路由器中都有 arp 缓存表用于缓存 IP 和 MAC 地址的映射关系
        - arp 缓存表是不断通过 arp 协议的请求逐步完善起来的。
  5. NOTE: <u>**网络层（IP协议）本身没有传输包的功能，包的实际传输是委托给数据链路层（以太网中的交换机）来实现的。**</u>
- 路由器总结 :
  - 通过网段的方式定位要把消息转发到哪，就不需要像交换机那样苦哈哈一条条记录 MAC 地址啦。
  - 路由器可以适配不同速度的网络
  - 路由器自己是有 MAC 地址的，因此 MAC 报头就可以写上，下一站目的地就是 xx 路由. 到了路由器后，路由器可以再次组装下一站的目的 MAC 地址是再下一个路由，通过这一点，让数据在路由和路由之间传输。
  - 找不到转发目的地时的处理方式有区别
    - 如果在路由表中无法找到匹配的记录，路由器会丢弃这个包，并通过 `ICMP` 消息告知发送方。
    - 而交换机在 MAC 地址表里找不到转发端口时会选择广播。
    - 这里的处理方式两者是不同的，原因在于网络规模的大小。
- 路由器和光猫之间是好搭档，光猫负责把光纤里的光信号转换成电信号给路由器。
- 现在一般情况下，**家里已经不用集线器和交换机了**，大部分路由器也支持交换机的功能。所以可以看到，家里的台式机电脑一般就连到一个路由器，再连个光猫就够能快乐上网了。
  - 集线器和交换机用于构建网络
  - 路由器用于连接网络
- 至此，经过物理层、数据链路层、网络层这前三层的协议，以及根据这些协议设计的各种网络设备（网线、集线器、交换机、路由器），**理论上只要拥有对方的 IP 地址**，就已经将地球上任意位置的两个节点连通了。
  - 如果 A 给 F 发送一个数据包，能不能通呢？如果通的话整个过程是怎样的呢？
    ![route 1](../image/net_route2.gif)

### <font color=#FF4500> ip/port </font>

- mac :
  - 用于网络物理层的传输, 局域网内使用
- ip : 用于标识电脑/设备, 通信必须要知道 src 和 dst 的 ip
  - ip 地址可变, mac 地址一般是不变的;
  - ip 用于定位 locate Device(定位最终的网络), mac 用于标识 identify Device(局域网内的哪个设备)
- port : 端口用于标识 ip 设备中的一个服务/应用
  - `0~1023`  :   常用于服务器监听, 公开
  - `1024~65535`  : 用于客户端接收

## <font color=#009A000> 0x01 TCP </font>

> [你管这破玩意儿叫TCP](https://mp.weixin.qq.com/s?__biz=MzkxMDc1MDg1Nw==&mid=2247509867&idx=1&sn=4a332d3f183f4458c664f7b5a5fe9058&chksm=c124428df653cb9bdc0f8202855f479317f6905c4233495fd369daa1eef01047a29a9f7c81d4&scene=178&cur_album_id=3642586631330267138#rd)
